<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>k</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: monospace;
            background: #000;
            color: #aaa;
            font-size: 13px;
        }

        .header {
            padding: 15px;
            border-bottom: 1px solid #222;
            background: #111;
        }

        .header h1 {
            color: #ccc;
            font-size: 18px;
            font-weight: normal;
        }

        .genres {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            padding: 10px;
            background: #111;
            border-bottom: 1px solid #222;
        }

        .genre {
            padding: 6px 12px;
            background: #222;
            border: none;
            color: #999;
            cursor: pointer;
        }

        .genre.active {
            background: #333;
            color: #fff;
        }

        .games {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
            padding: 15px;
        }

        .game {
            position: relative;
            overflow: hidden;
        }

        .game img {
            width: 100%;
            height: 190px;
            object-fit: cover;
            filter: grayscale(30%);
            transition: filter 0.2s;
        }

        .game:hover img {
            filter: grayscale(0%);
        }

        .game-title {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.85);
            padding: 5px;
            font-size: 11px;
            color: #ddd;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.97);
            display: none;
            z-index: 100;
        }

        .overlay-content {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            bottom: 20px;
            background: #111;
            border: 1px solid #222;
            padding: 20px;
            overflow-y: auto;
        }

        .close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #222;
            color: #999;
            border: none;
            width: 25px;
            height: 25px;
            cursor: pointer;
        }

        .details-main {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .details-image {
            width: 100%;
            height: 300px;
            object-fit: cover;
        }

        .details-video {
            width: 100%;
            height: 300px;
            object-fit: cover;
            background: #000;
        }

        .download-link {
            display: inline-block;
            background: #222;
            color: #ccc;
            padding: 8px 16px;
            text-decoration: none;
            border: 1px solid #333;
            margin-top: 10px;
        }

        .pagination {
            padding: 15px;
            text-align: center;
            border-top: 1px solid #222;
        }

        .page-btn {
            background: #222;
            color: #999;
            border: 1px solid #333;
            padding: 6px 12px;
            margin: 0 5px;
            cursor: pointer;
        }

        .page-btn.active {
            background: #333;
            color: #fff;
        }

        .loading {
            padding: 30px;
            text-align: center;
            color: #666;
        }

        .loading::after {
            content: "...";
            animation: dots 1.5s infinite;
        }

        @keyframes dots {

            0%,
            20% {
                content: ".";
            }

            40% {
                content: "..";
            }

            60%,
            100% {
                content: "...";
            }
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>koyso</h1>
    </div>

    <div class="genres" id="genres"></div>

    <div class="games" id="games">
        <div class="loading">loading</div>
    </div>

    <div class="pagination" id="pagination"></div>

    <div class="overlay" id="overlay">
        <div class="overlay-content">
            <button class="close" onclick="closeOverlay()">×</button>
            <div id="details"></div>
        </div>
    </div>

    <script>
        let currentGenre = '1'
        let currentPage = 1
        let isLoading = false
        let hasMore = true
        let allGames = []

        function init() {
            fetch('/genres').then(r => r.json()).then(genres => {
                const container = document.getElementById('genres')
                genres.forEach(genre => {
                    const btn = document.createElement('button')
                    btn.className = 'genre'
                    btn.textContent = genre.name
                    btn.onclick = () => selectGenre(genre.id)
                    container.appendChild(btn)
                })
                if (genres.length > 0) {
                    document.querySelector('.genre').classList.add('active')
                    loadPage()
                }
            })

            window.addEventListener('scroll', () => {
                if (isLoading || !hasMore) return
                if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 500) {
                    currentPage++
                    loadPage()
                }
            })
        }

        function selectGenre(genreId) {
            document.querySelectorAll('.genre').forEach(btn => btn.classList.remove('active'))
            event.target.classList.add('active')

            currentGenre = genreId
            currentPage = 1
            allGames = []
            hasMore = true
            document.getElementById('games').innerHTML = '<div class="loading">loading</div>'
            document.getElementById('pagination').innerHTML = ''
            loadPage()
        }

        function loadPage() {
            if (isLoading || !hasMore) return
            isLoading = true

            fetch(`/games/${currentGenre}/${currentPage}`)
                .then(r => r.json())
                .then(data => {
                    hasMore = data.has_next
                    allGames = [...allGames, ...data.games]
                    displayGames()
                    updatePagination()
                    isLoading = false
                })
                .catch(() => {
                    isLoading = false
                })
        }

        function displayGames() {
            const container = document.getElementById('games')
            container.innerHTML = ''

            allGames.forEach(game => {
                const gameEl = document.createElement('div')
                gameEl.className = 'game'
                gameEl.onclick = () => showDetails(game)

                gameEl.innerHTML = `
                    <img src="${game.image_url}" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚫</text></svg>'">
                    <div class="game-title">${game.title}</div>
                `

                container.appendChild(gameEl)
            })

            if (hasMore) {
                const loading = document.createElement('div')
                loading.className = 'loading'
                loading.textContent = 'loading more'
                container.appendChild(loading)
            }
        }

        function updatePagination() {
            const container = document.getElementById('pagination')
            if (currentPage <= 1 && !hasMore) {
                container.innerHTML = ''
                return
            }

            let html = ''
            if (currentPage > 1) {
                html += `<button class="page-btn" onclick="goToPage(${currentPage - 1})">←</button>`
            }
            html += `<span style="color:#777; margin:0 10px;">${currentPage}</span>`
            if (hasMore) {
                html += `<button class="page-btn" onclick="goToPage(${currentPage + 1})">→</button>`
            }
            container.innerHTML = html
        }

        function goToPage(page) {
            currentPage = page
            loadPage()
            window.scrollTo(0, 0)
        }

        function showDetails(game) {
            document.getElementById('overlay').style.display = 'block'
            document.getElementById('details').innerHTML = '<div class="loading">loading details</div>'

            fetch(`/details?url=${encodeURIComponent(game.url)}`)
                .then(r => r.json())
                .then(details => {
                    if (details.error) {
                        document.getElementById('details').innerHTML = `<div style="color:#777">error loading details</div>`
                        return
                    }

                    let videoHtml = ''
                    if (details.video_url) {
                        videoHtml = `
                            <div>
                                <video class="details-video" controls>
                                    <source src="${details.video_url}" type="video/mp4">
                                </video>
                            </div>
                        `
                    }

                    let downloadHtml = ''
                    if (details.final_download_url) {
                        downloadHtml = `
                            <div style="margin-top:20px;">
                                <a href="${details.final_download_url}" class="download-link" target="_blank">
                                    download [${details.file_size || '?'}]
                                </a>
                            </div>
                        `
                    } else if (details.file_size) {
                        downloadHtml = `
                            <div style="margin-top:20px; color:#777;">
                                size: ${details.file_size}
                            </div>
                        `
                    }

                    let descriptionHtml = ''
                    if (details.description && details.description.trim().length > 0) {
                        const fullDesc = details.description
                        const displayDesc = fullDesc.length > 500 ? fullDesc.substring(0, 500) + '...' : fullDesc
                        descriptionHtml = `
                            <div style="margin-top:20px; color:#999; line-height:1.6; white-space: pre-wrap;">
                                ${displayDesc}
                            </div>
                        `
                    }

                    document.getElementById('details').innerHTML = `
                        <h2 style="margin-bottom:20px; color:#ccc;">${details.title || game.title}</h2>
                        <div class="details-main">
                            <div>
                                <img src="${details.image_url || game.image_url}" class="details-image" onerror="this.style.display='none'">
                            </div>
                            ${videoHtml}
                        </div>
                        ${descriptionHtml}
                        ${downloadHtml}
                    `
                })
                .catch(() => {
                    document.getElementById('details').innerHTML = `<div style="color:#777">failed to load</div>`
                })
        }

        function closeOverlay() {
            document.getElementById('overlay').style.display = 'none'
        }

        init()
    </script>
</body>

</html>